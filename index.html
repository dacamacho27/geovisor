<script>
  let capaActual = []; // almacenará marcadores actuales

  async function previewTabla(url, key, tabla) {
    const status = document.getElementById('status');
    const preview = document.getElementById('preview');
    preview.innerHTML = '';
    status.textContent = `⏳ Cargando primeras filas de "${tabla}"…`;

    try {
      const r = await fetch(`${url}/rest/v1/${tabla}?select=*&limit=1000`, {
        headers: { 'apikey': key, 'Authorization': `Bearer ${key}` }
      });
      if (!r.ok) throw new Error(r.statusText);
      const data = await r.json();

      // Mostrar tabla
      let html = `<h3>Primeras filas de <strong>${tabla}</strong></h3>`;
      if (!data.length) {
        html += '<p>— tabla vacía —</p>';
      } else {
        html += '<table><tr>';
        Object.keys(data[0]).forEach(c => html += `<th>${c}</th>`);
        html += '</tr>';
        data.forEach(row => {
          html += '<tr>';
          Object.values(row).forEach(v => html += `<td>${v}</td>`);
          html += '</tr>';
        });
        html += '</table>';
      }
      preview.innerHTML = html;
      status.textContent = `✅ Datos de "${tabla}" cargados`;

      // Si contiene coordenadas, mostrar en mapa
      if ('latitud' in data[0] && 'longitud' in data[0]) {
        // limpiar capa anterior
        capaActual.forEach(m => map.removeLayer(m));
        capaActual = [];

        data.forEach(item => {
          if (item.latitud && item.longitud) {
            const marcador = L.marker([item.latitud, item.longitud])
              .addTo(map)
              .bindPopup(Object.entries(item).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br>'));
            capaActual.push(marcador);
          }
        });

        map.setView([data[0].latitud, data[0].longitud], 14);
      }

    } catch (err) {
      status.textContent = '❌ Error: ' + err.message;
    }
  }
</script>
